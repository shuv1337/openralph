#!/usr/bin/env node
/**
 * Ralph CLI Launcher
 *
 * This is a thin JavaScript wrapper that finds and executes the correct
 * platform-specific binary for the current OS/architecture.
 *
 * The binary is located in one of the optional dependency packages:
 *   - @hona/ralph-cli-darwin-arm64
 *   - @hona/ralph-cli-darwin-x64
 *   - @hona/ralph-cli-linux-arm64
 *   - @hona/ralph-cli-linux-x64
 *   - @hona/ralph-cli-windows-x64
 *
 * Environment variables:
 *   RALPH_BIN_PATH - Override path to the ralph binary
 */

const childProcess = require("child_process");
const fs = require("fs");
const path = require("path");
const os = require("os");
const { createRequire } = require("module");

/**
 * Run the binary with inherited stdio
 */
function run(target) {
  const result = childProcess.spawnSync(target, process.argv.slice(2), {
    stdio: "inherit",
  });

  if (result.error) {
    console.error(result.error.message);
    process.exit(1);
  }

  const code = typeof result.status === "number" ? result.status : 0;
  process.exit(code);
}

// Check for environment variable override
const envPath = process.env.RALPH_BIN_PATH;
if (envPath) {
  run(envPath);
}

// Map OS and architecture to package naming conventions
const platformMap = {
  darwin: "darwin",
  linux: "linux",
  win32: "windows",
};

const archMap = {
  x64: "x64",
  arm64: "arm64",
};

let platform = platformMap[os.platform()];
if (!platform) {
  platform = os.platform();
}

let arch = archMap[os.arch()];
if (!arch) {
  arch = os.arch();
}

// Construct package and binary names
const packageName = "@hona/ralph-cli-" + platform + "-" + arch;
const binaryName = platform === "windows" ? "ralph.exe" : "ralph";

/**
 * Find the binary using Node's require.resolve (handles scoped packages correctly)
 */
function findBinaryWithRequire() {
  try {
    // Create a require function relative to this script
    const localRequire = createRequire(__filename);
    const packageJsonPath = localRequire.resolve(packageName + "/package.json");
    const packageDir = path.dirname(packageJsonPath);
    const binaryPath = path.join(packageDir, "bin", binaryName);

    if (fs.existsSync(binaryPath)) {
      return binaryPath;
    }
  } catch (e) {
    // Package not found via require.resolve
  }
  return null;
}

/**
 * Fallback: Search for the binary in node_modules hierarchy manually
 * Handles scoped packages stored at node_modules/@scope/package-name
 */
function findBinaryManual(startDir) {
  // For scoped package @hona/ralph-cli-linux-x64, we need to look at:
  // node_modules/@hona/ralph-cli-linux-x64/bin/ralph
  const scopedParts = packageName.split("/");
  const scope = scopedParts[0]; // "@hona"
  const pkgName = scopedParts[1]; // "ralph-cli-linux-x64"

  let current = startDir;
  for (;;) {
    const modules = path.join(current, "node_modules");

    if (fs.existsSync(modules)) {
      // Check scoped package path: node_modules/@hona/ralph-cli-{platform}-{arch}
      const scopedPath = path.join(modules, scope, pkgName, "bin", binaryName);
      if (fs.existsSync(scopedPath)) {
        return scopedPath;
      }
    }

    // Move up to parent directory
    const parent = path.dirname(current);
    if (parent === current) {
      // Reached filesystem root
      return null;
    }
    current = parent;
  }
}

// Try to find the binary - first with require.resolve, then manual search
const scriptPath = fs.realpathSync(__filename);
const scriptDir = path.dirname(scriptPath);

let resolved = findBinaryWithRequire();
if (!resolved) {
  resolved = findBinaryManual(scriptDir);
}

if (!resolved) {
  console.error(
    "Error: Could not find the ralph binary for your platform.\n\n" +
      "It seems that your package manager failed to install the correct version\n" +
      "of the ralph CLI for your platform (" +
      platform +
      "-" +
      arch +
      ").\n\n" +
      'You can try manually installing the "' +
      packageName +
      '" package:\n\n' +
      "  npm install " +
      packageName +
      "\n"
  );
  process.exit(1);
}

run(resolved);
